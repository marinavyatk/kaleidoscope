import { useState } from 'react';
import Head from 'next/head';
import Header from '@/components/header/header';
import { GreetingSection } from '@/sections/greeting/greetingSection';
import Player from '@/components/player/player';
import { api } from '@/common/api';
import { Category, ContactsData, DocumentData, Faq, ProjectMap, StepData } from '@/common/types';
import s from '@/styles/index.module.scss';
import { getStructuredProjectMap } from '@/common/commonFunctions';
import ErrorBoundary from '@/components/errorBoundary/errorBoundary';
import MainSection from '@/sections/main/mainSection';
import AboutSection from '@/sections/about/aboutSection';
import CatalogSection from '@/sections/catalog/catalogSection';
import ProjectMapSection from '@/sections/projectMap/projectMapSection';
import FAQ from '@/sections/faq/faq';
import FormSection from '@/sections/form/formSection';
import DocumentationSection from '@/sections/documentation/documentationSection';
import Footer from '@/components/footer/footer';

export const getStaticProps = async () => {
  const contactInfo = (await api.getContacts()) || {};
  const categories = (await api.getProductsCategories()) || [];
  const documents = (await api.getDocuments()) || [];
  const faqData = (await api.getFAQ()) || [];
  const projectMapData = (await api.getProjectMap()) || [];
  const { projectMap, stepData } = getStructuredProjectMap(projectMapData);

  return { props: { contactInfo, categories, documents, projectMap, stepData, faqData } };
};

type HomeProps = {
  contactInfo: ContactsData;
  categories: Category[];
  documents: DocumentData[];
  projectMap: ProjectMap[];
  stepData: StepData[];
  faqData: Faq[];
};

export default function Home(props: HomeProps) {
  console.log('Index');
  const { contactInfo, categories, documents, projectMap, stepData, faqData } = props;
  const [showGreeting, setShowGreeting] = useState(true);
  const [initialPlaying, setInitialPlaying] = useState(false);

  return (
    <>
      <Head>
        <title>Калейдоскоп игр</title>
        <meta name='description' content='Generated by create next app' />
        <meta name='viewport' content='width=device-width, initial-scale=1' />
        <link rel='apple-touch-icon' sizes='180x180' href='/favicon/apple-touch-icon.png' />
        <link rel='icon' type='image/png' sizes='32x32' href='/favicon/favicon-32x32.png' />
        <link rel='icon' type='image/png' sizes='16x16' href='/favicon/favicon-16x16.png' />
        <link rel='manifest' href='/favicon/site.webmanifest' />
        <link rel='icon' href='/favicon/favicon.ico' />
        <link rel='manifest' href='/favicon/site.webmanifest' />
        <link rel='mask-icon' href='/favicon/safari-pinned-tab.svg' color='#5bbad5' />
        <meta name='msapplication-config' content='/favicon/browserconfig.xml' />
      </Head>
      <ErrorBoundary>
        <div className='mainContainer'>
          {showGreeting && (
            <GreetingSection
              setShowGreeting={setShowGreeting}
              setPlaying={setInitialPlaying}
              className={!showGreeting ? s.hiddenGreeting : ''}
            />
          )}
          <div className={showGreeting ? s.hidden : ''}>
            <Header
              className={s.header}
              player={<Player initialPlaying={initialPlaying} key={`playing-${initialPlaying}`} />}
            />
            <main>
              <MainSection />
              <AboutSection />
              <CatalogSection categories={categories} />
              <ProjectMapSection projectMap={projectMap} stepData={stepData} />
              <FAQ faqData={faqData} />
              <FormSection />
              <DocumentationSection documents={documents} />
            </main>
            <Footer
              tels={contactInfo['contact_phones']}
              emails={contactInfo['contact_emails']}
              socialLinks={contactInfo['social_links']}
            />
          </div>
        </div>
      </ErrorBoundary>
    </>
  );
}
