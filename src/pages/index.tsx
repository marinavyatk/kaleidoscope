import { useState } from 'react';
import Head from 'next/head';
import Header from '@/components/header/header';
import { GreetingSection } from '@/sections/greeting/greetingSection';
import Player from '@/components/player/player';
import { api } from '@/common/api';
import { Category, ContactsData, DocumentData, Faq, ProjectMap, StepData } from '@/common/types';
import s from '@/styles/index.module.scss';
import { getStructuredProjectMap } from '@/common/commonFunctions';
import ErrorBoundary from '@/components/errorBoundary/errorBoundary';
import dynamic from 'next/dynamic';
const MainSection = dynamic(() => import('@/sections/main/mainSection'));
const AboutSection = dynamic(() => import('@/sections/about/aboutSection'));
const CatalogSection = dynamic(() => import('@/sections/catalog/catalogSection'));
const ProjectMapSection = dynamic(() => import('@/sections/projectMap/projectMapSection'));
const FAQ = dynamic(() => import('@/sections/faq/faq'));
const FormSection = dynamic(() => import('@/sections/form/formSection'));
const DocumentationSection = dynamic(() => import('@/sections/documentation/documentationSection'));
const Footer = dynamic(() => import('../components/footer/footer'));

export const getStaticProps = async () => {
  const contactInfo = (await api.getContacts()) || {};
  const categories = (await api.getProductsCategories()) || [];
  const documents = (await api.getDocuments()) || [];
  const faqData = (await api.getFAQ()) || [];
  const projectMapData = (await api.getProjectMap()) || [];
  const { projectMap, stepData } = getStructuredProjectMap(projectMapData);

  console.log('Fetched data for static generation:', {
    contactInfo: contactInfo,
    categories: categories,
    documents: documents,
    faqData: faqData,
    projectMapData: projectMapData,
  });

  return { props: { contactInfo, categories, documents, projectMap, stepData, faqData } };
};

type HomeProps = {
  contactInfo: ContactsData;
  categories: Category[];
  documents: DocumentData[];
  projectMap: ProjectMap[];
  stepData: StepData[];
  faqData: Faq[];
};

export default function Home(props: HomeProps) {
  const { contactInfo, categories, documents, projectMap, stepData, faqData } = props;
  const [showGreeting, setShowGreeting] = useState(true);
  const [initialPlaying, setInitialPlaying] = useState(false);

  return (
    <>
      <Head>
        <title>Калейдоскоп игр</title>
        <meta name='description' content='Generated by create next app' />
        <meta name='viewport' content='width=device-width, initial-scale=1' />
      </Head>
      <ErrorBoundary>
        <div className='mainContainer'>
          {showGreeting && (
            <GreetingSection
              setShowGreeting={setShowGreeting}
              setPlaying={setInitialPlaying}
              className={!showGreeting ? s.hiddenGreeting : ''}
            />
          )}
          <div className={showGreeting ? s.hidden : ''}>
            <Header
              className={s.header}
              player={<Player initialPlaying={initialPlaying} key={`playing-${initialPlaying}`} />}
            />
            <MainSection />
            <AboutSection />
            <CatalogSection categories={categories} />
            <ProjectMapSection projectMap={projectMap} stepData={stepData} />
            <FAQ faqData={faqData} />
            <FormSection />
            <DocumentationSection documents={documents} />
            <Footer
              tels={contactInfo['contact_phones']}
              emails={contactInfo['contact_emails']}
              socialLinks={contactInfo['social_links']}
            />
          </div>
        </div>
      </ErrorBoundary>
    </>
  );
}
